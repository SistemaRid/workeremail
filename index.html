<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Worker RID</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>

<h2>Worker de E-mails RID</h2>
<p>Status: <span id="status">iniciandoâ€¦</span></p>

<script>
    emailjs.init("2AYL-lDTSgF5yPjHB");
    console.log("ğŸ”¥ SCRIPT DO WORKER CARREGOU");
const firebaseConfig = {
  apiKey: "AIzaSyDAcuwo5FZBs5013klfSMfWkQZbFjqYpbw",
  authDomain: "novo-rid-dezembro.firebaseapp.com",
  projectId: "novo-rid-dezembro"
};

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const statusEl = document.getElementById("status");

  auth.onAuthStateChanged(async user => {
    if (!user) {
      statusEl.innerText = "faÃ§a login";
      return;
    }

    const userDoc = await db.collection("users").doc(user.uid).get();
    if (!userDoc.data().isAdmin) {
      statusEl.innerText = "nÃ£o Ã© admin";
      return;
    }

   statusEl.innerText = "worker rodando";

// ğŸ”¥ executa imediatamente
runWorker();

// ğŸ” depois executa a cada 1 minuto
setInterval(runWorker, 60000);

  });

 async function runWorker() {
  console.log("ğŸ” Worker executando (modo normal)");

  const stateRef = db.doc("system/emailWorker");
  const stateSnap = await stateRef.get();
  const lastChecked = stateSnap.data()?.lastChecked;

  let query = db.collection("rids")
    .orderBy("createdAt")
    .limit(5);

  if (lastChecked) {
    query = query.where("createdAt", ">", lastChecked);
  }

  const snapshot = await query.get();

if (snapshot.empty) {
  console.log("âš ï¸ Nenhuma RID nova encontrada");
  return;
}

// ğŸ”’ pega somente a PRIMEIRA RID
const doc = snapshot.docs[0];
const rid = doc.data();

// ğŸ”’ atualiza o estado ANTES de enviar
await stateRef.update({
  lastChecked: rid.createdAt
});

// ğŸ”’ fallback de e-mail (2 destinatÃ¡rios)
let toEmail = "sistemarids@gmail.com, cesar.costa@jdemito.com.br";

let shouldNotify = false;

// ğŸ“Œ NOVA RID (ainda nÃ£o notificada)
if (!rid.lastNotifiedLeader && rid.responsibleLeader) {
  shouldNotify = true;
}

// ğŸ” TROCA DE LÃDER
if (
  rid.lastNotifiedLeader &&
  rid.responsibleLeader &&
  rid.lastNotifiedLeader !== rid.responsibleLeader
) {
  shouldNotify = true;
}

if (!shouldNotify) {
  console.log("â„¹ï¸ Nenhuma mudanÃ§a de lÃ­der para notificar:", rid.ridNumber);
  return;
}

// ğŸ” busca e-mail do lÃ­der atual
const leaderSnap = await db
  .collection("users")
  .doc(rid.responsibleLeader)
  .get();

if (!leaderSnap.exists || !leaderSnap.data().email) {
  console.log("âš ï¸ LÃ­der sem e-mail vÃ¡lido:", rid.responsibleLeader);
  return;
}

toEmail = leaderSnap.data().email;


console.log("ğŸ“© Enviando e-mail da RID:", rid.ridNumber, "para", toEmail);

await emailjs.send(
  "service_mfu6oes",
  "template_47puito",
  {
    ridNumber: rid.ridNumber,
    emitterName: rid.emitterName || "NÃ£o informado",
    sector: rid.sector,
    riskClassification: rid.riskClassification,
    status: rid.status,
    description: rid.description,
    to_email: toEmail
  }
);

await db.collection("rids").doc(doc.id).update({
  lastNotifiedLeader: rid.responsibleLeader
});



console.log("âœ… E-mail enviado:", rid.ridNumber);
}

</script>

</body>
</html>
