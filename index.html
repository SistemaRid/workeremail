<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Worker RID</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
</head>
<body>

<h2>Worker de E-mails RID</h2>
<p>Status: <span id="status">inicializando‚Ä¶</span></p>

<script>
/* =========================
   CONFIGURA√á√ïES
========================= */


const firebaseConfig = {
  apiKey: "AIzaSyDAcuwo5FZBs5013klfSMfWkQZbFjqYpbw",
  authDomain: "novo-rid-dezembro.firebaseapp.com",
  projectId: "novo-rid-dezembro"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const statusEl = document.getElementById("status");

statusEl.innerText = "worker ativo";

const EMAIL_API_URL = "https://script.google.com/macros/s/AKfycbz7PbsocqiVbz7L2PswdXqiayyZb5OdGlk7NLCusjY4i9OMS82EnlTsdN15fZ5nUdHm5w/exec";
const EMAIL_API_KEY = "611969Aa@";


/* =========================
   EXECU√á√ÉO
========================= */

runWorker();
setInterval(runWorker, 60000);

async function sendEmail(to, subject, html) {
  const resp = await fetch(EMAIL_API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "text/plain;charset=utf-8"
    },
    body: JSON.stringify({
      key: EMAIL_API_KEY,
      to,
      subject,
      html
    })
  });

  const result = await resp.json();
  if (!result.ok) {
    throw new Error(result.error || "Erro ao enviar e-mail");
  }
}

async function runWorker() {
  console.log("üîÅ Worker executando");

  try {
    const snapshot = await db
  .collection("rids")
  .where("emailSent", "==", false)
  .where("status", "in", ["VENCIDO", "CORRIGIDO"])
  .orderBy("createdAt")
  .limit(1)
  .get();

    if (snapshot.empty) {
      console.log("üì≠ Nenhuma RID pendente");
      return;
    }

    const doc = snapshot.docs[0];
    const rid = doc.data();

    let shouldSend = false;

// 1Ô∏è‚É£ RID sem l√≠der ‚Üí envia fallback UMA VEZ
if (!rid.responsibleLeader && !rid.lastNotifiedLeader) {
  shouldSend = true;
}

// 2Ô∏è‚É£ RID com l√≠der novo ou trocado
if (
  rid.responsibleLeader &&
  rid.responsibleLeader !== rid.lastNotifiedLeader
) {
  shouldSend = true;
}

if (!shouldSend) {
  console.log("‚ÑπÔ∏è Nenhum envio necess√°rio para RID", rid.ridNumber);
  return;
}



    // fallback
    let toEmail = "sistemarids@gmail.com, cesar.costa@jdemito.com.br";

    // tenta buscar e-mail do l√≠der (se existir)
    if (rid.responsibleLeader) {
      const leaderSnap = await db
        .collection("leaders_public")
        .doc(rid.responsibleLeader)
        .get();

      if (leaderSnap.exists && leaderSnap.data().email) {
        toEmail = leaderSnap.data().email;
      }
    }

    console.log("üì© Enviando e-mail RID:", rid.ridNumber, "‚Üí", toEmail);

    await sendEmail(
  toEmail,
  `RID #${rid.ridNumber} - ${rid.status}`,
  `
    <h2>RID #${rid.ridNumber}</h2>

    <p><b>Status:</b> ${rid.status}</p>
    <p><b>Emitente:</b> ${rid.emitterName || "N√£o informado"}</p>
    <p><b>Setor:</b> ${rid.sector || "-"}</p>
    <p><b>Classifica√ß√£o de Risco:</b> ${rid.riskClassification || "-"}</p>

    <p><b>Descri√ß√£o:</b><br>${rid.description || "-"}</p>

    <p>
      <a href="https://sistemarid.github.io/Privado-v1.20/">
        üîó Abrir RID no sistema
      </a>
    </p>

    <hr>
    <small>
      Este e-mail √© autom√°tico. N√£o responda.
    </small>
  `
);


// üî• MARCA QUEM J√Å FOI NOTIFICADO
await db.collection("rids").doc(doc.id).update({
  emailSent: true,
  emailSentAt: new Date(),
  lastNotifiedLeader: rid.responsibleLeader || "FALLBACK"
});

console.log("‚úÖ E-mail enviado com sucesso:", rid.ridNumber);


  } catch (err) {
    console.error("‚ùå Erro no worker:", err);
  }
}
</script>

</body>
</html>
