<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Worker RID</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>

<h2>Worker de E-mails RID</h2>
<p>Status: <span id="status">inicializando‚Ä¶</span></p>

<script>
/* =========================
   CONFIGURA√á√ïES
========================= */

emailjs.init("2AYL-lDTSgF5yPjHB");

const firebaseConfig = {
  apiKey: "AIzaSyDAcuwo5FZBs5013klfSMfWkQZbFjqYpbw",
  authDomain: "novo-rid-dezembro.firebaseapp.com",
  projectId: "novo-rid-dezembro"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const statusEl = document.getElementById("status");

statusEl.innerText = "worker ativo";

/* =========================
   EXECU√á√ÉO
========================= */

runWorker();
setInterval(runWorker, 60000);

async function runWorker() {
  console.log("üîÅ Worker executando");

  try {
    const snapshot = await db
      .collection("rids")
      .where("emailSent", "==", false)
      .where("status", "in", ["VENCIDO", "CORRIGIDO"])
      .orderBy("createdAt")
      .limit(1)
      .get();

    if (snapshot.empty) {
      console.log("üì≠ Nenhuma RID pendente");
      return;
    }

    const doc = snapshot.docs[0];
    const rid = doc.data();

    // fallback
    let toEmail = "sistemarids@gmail.com, cesar.costa@jdemito.com.br";

    // tenta buscar e-mail do l√≠der (se existir)
    if (rid.responsibleLeader) {
      const leaderSnap = await db
        .collection("leaders_public")
        .doc(rid.responsibleLeader)
        .get();

      if (leaderSnap.exists && leaderSnap.data().email) {
        toEmail = leaderSnap.data().email;
      }
    }

    console.log("üì© Enviando e-mail RID:", rid.ridNumber, "‚Üí", toEmail);

    await emailjs.send(
      "service_mfu6oes",
      "template_47puito",
      {
        ridNumber: rid.ridNumber,
        emitterName: rid.emitterName || "N√£o informado",
        sector: rid.sector || "-",
        riskClassification: rid.riskClassification || "-",
        status: rid.status,
        description: rid.description || "-",
        to_email: toEmail
      }
    );

    // marca como enviado
    await db.collection("rids").doc(doc.id).update({
      emailSent: true,
      emailSentAt: new Date()
    });

    console.log("‚úÖ E-mail enviado com sucesso:", rid.ridNumber);

  } catch (err) {
    console.error("‚ùå Erro no worker:", err);
  }
}
</script>

</body>
</html>
